<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Blog especializado en apicultura, genética de abejas, polinización y prácticas sostenibles en colmenares. Información actualizada del sector apícola." />
    <title>Blog - Colmenares Saavedra Armijo SPA</title>
    <!-- Precargar recursos críticos -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons" as="style">
    
    <!-- Cargar estilos con atributos de rendimiento -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" media="print" onload="this.media='all'">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="blog-styles.css" media="print" onload="this.media='all'">
  </head>

  <body class="text-secondary">
    <header class="bg-secondary text-white shadow-lg">
      <div class="container py-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <img alt="Logotipo Colmenares Saavedra Armijo SPA - Abeja en un panal" class="h-16 me-2 me-md-3" src="imagenes/logocafe.png" loading="eager" style="height: clamp(2.5rem, 4vw, 4rem);" />
            <h1 class="fs-5 fs-md-4 fw-bold mb-0 d-none d-sm-block">Colmenares Saavedra Armijo SPA</h1>
            <h1 class="fs-6 fw-bold mb-0 d-block d-sm-none">Colmenares SPA</h1>
          </div>
          
          <!-- Botón hamburguesa para móviles -->
          <button class="navbar-toggler d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          
          <!-- Navegación desktop -->
          <nav class="d-none d-md-block">
            <ul class="nav">
              <li class="nav-item">
                <a class="nav-link text-white hover-accent active" href="index1.html">Inicio</a>
              </li>
              <li class="nav-item">
                <button id="btn-cambiar-idioma" class="nav-traduccion border-0 rounded-pill ms-3 d-flex align-items-center">
                  <img src="https://flagcdn.com/w20/es.png" alt="Español" class="me-2" loading="lazy" width="24" height="18">
                  <span class="mx-2">/</span>
                  <img src="https://flagcdn.com/w20/gb.png" alt="English" loading="lazy" width="24" height="18">
                </button>
              </li>
            </ul>
          </nav>
        </div>
        
        <!-- Navegación móvil colapsable -->
        <div class="collapse navbar-collapse d-md-none" id="navbarNav">
          <ul class="nav flex-column mt-3">
            <li class="nav-item">
              <a class="nav-link text-white hover-accent active" href="index1.html">Inicio</a>
            </li>
            <li class="nav-item mt-2">
              <button id="btn-cambiar-idioma-mobile" class="nav-traduccion border-0 rounded-pill d-flex align-items-center">
                <img src="https://flagcdn.com/w20/es.png" alt="Español" class="me-2" loading="lazy" width="24" height="18">
                <span class="mx-2">/</span>
                <img src="https://flagcdn.com/w20/gb.png" alt="English" loading="lazy" width="24" height="18">
              </button>
            </li>
          </ul>
        </div>
      </div>
    </header>

    <main>
      <section class="blog-header">
        <div class="container">
          <h1 class="blog-title text-center">Nuestro Blog</h1>
          <p class="blog-description text-center">
            Descubre las últimas tendencias y noticias del sector apícola. Nuestros expertos comparten análisis, consejos y guías para ayudarte a mantenerte al día.
          </p>
          
          <!-- Buscador -->
          <div class="search-container my-4">
            <div class="input-group w-100 w-md-75 mx-auto">
              <input type="search" id="searchInput" class="form-control" placeholder="Buscar artículos..." aria-label="Buscar artículos">
              <button class="btn custom-search-btn" type="button" id="searchButton">
                <span class="material-icons">search</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="py-5 bg-light">
        <div class="container">
          <!-- Filtros -->
          <div class="blog-filters d-flex justify-content-center gap-2 gap-md-3 flex-wrap mb-4">
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="fechaDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="material-icons me-1 me-md-2">schedule</span>
                <span class="d-none d-sm-inline">Ordenar por Fecha</span>
                <span class="d-inline d-sm-none">Fecha</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="fechaDropdown">
                <li><a class="dropdown-item" href="#" data-orden="fecha_desc">Más recientes primero</a></li>
                <li><a class="dropdown-item" href="#" data-orden="fecha_asc">Más antiguos primero</a></li>
              </ul>
            </div>
            
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="categoriaDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="material-icons me-1 me-md-2">category</span>
                <span class="d-none d-sm-inline">Filtrar por Etiqueta</span>
                <span class="d-inline d-sm-none">Etiqueta</span>
              </button>
              <ul class="dropdown-menu" id="categoriasDropdown" aria-labelledby="categoriaDropdown">
                <li><a class="dropdown-item" href="#" data-categoria="">Todas las etiquetas</a></li>
                <!-- Las categorías se cargarán dinámicamente -->
              </ul>
            </div>
            
            <button class="btn btn-outline-primary" id="btn-limpiar-filtros">
              <span class="material-icons me-1 me-md-2">clear</span>
              <span class="d-none d-sm-inline">Limpiar Filtros</span>
              <span class="d-inline d-sm-none">Limpiar</span>
            </button>
          </div>

          <!-- Blog Cards -->
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 g-md-4" id="postsContainer">
            <!-- Los posts se cargarán dinámicamente aquí desde la base de datos -->
          </div>

          <!-- Botón Cargar más/menos -->
          <div class="load-more-container text-center mt-5">
            <button class="btn btn-load-more" id="btn-cargar-mas">
              <span>Cargar más artículos</span>
              <span class="material-icons">expand_more</span>
            </button>
            <button class="btn btn-outline-secondary d-none" id="btn-cargar-menos">
              <span>Ver menos artículos</span>
              <span class="material-icons">expand_less</span>
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Botón Volver arriba -->
    <button id="btn-volver-arriba" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-3 m-md-4 d-none" aria-label="Volver arriba" style="width: clamp(3rem, 8vw, 4rem); height: clamp(3rem, 8vw, 4rem);">
      <span class="material-icons" style="font-size: clamp(1.25rem, 3vw, 1.5rem);">arrow_upward</span>
    </button>

    <footer class="blog-footer">
      <div class="container text-center">
        <div class="mb-4">
          <img alt="Logotipo Colmenares Saavedra Armijo SPA en pie de página - Abeja dorada" class="mb-3" src="imagenes/logocafe.png" style="height: clamp(2.5rem, 6vw, 3.5rem);"/>
          <p class="fs-5 fs-md-4 fw-semibold mb-0">Colmenares Saavedra Armijo SPA</p>
          <p class="fs-6">Melipilla, Chile</p>
        </div>
        <div class="mb-4 fs-6 fs-md-5">
          <a href="mailto:contacto@colmenaressaavedra.cl" class="text-white text-decoration-none">contacto@colmenaressaavedra.cl</a>
          <span class="mx-2 mx-md-3 d-none d-md-inline">|</span>
          <br class="d-md-none">
          <a href="tel:+56912345678" class="text-white text-decoration-none">+56 9 1234 5678</a>
        </div>
        <p class="fs-6 mb-0">&copy; 2025 Colmenares Saavedra Armijo SPA. Todos los derechos reservados.</p>
      </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="mb-3">
                <label for="username" class="form-label">Usuario</label>
                <input type="text" class="form-control" id="username" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" required>
              </div>
              <div class="alert alert-danger d-none" id="loginError"></div>
            </form>
            <div class="text-center mt-3">
              <a href="#" id="forgotPasswordLink" class="text-secondary">¿Olvidaste tu contraseña?</a>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-secondary" id="loginButton">Iniciar Sesión</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Solicitar recuperación de contraseña -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="forgotPasswordModalLabel">Recuperar contraseña</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="forgotPasswordForm">
              <div class="mb-3">
                <label for="forgotCorreo" class="form-label">Correo electrónico</label>
                <input type="email" class="form-control" id="forgotCorreo" required>
              </div>
              <div class="alert alert-info d-none" id="forgotPasswordMsg"></div>
              <button type="button" class="btn btn-secondary w-100" id="enviarCodigoBtn">Enviar código</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Ingresar código de recuperación -->
    <div class="modal fade" id="verifyTokenModal" tabindex="-1" aria-labelledby="verifyTokenModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="verifyTokenModalLabel">Verifica tu código</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="verifyTokenForm">
              <div class="mb-3">
                <label for="verifyToken" class="form-label">Código recibido</label>
                <input type="text" class="form-control" id="verifyToken" required>
              </div>
              <div class="alert alert-info d-none" id="verifyTokenMsg"></div>
              <button type="button" class="btn btn-secondary w-100" id="verificarCodigoBtn">Verificar código</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Nueva contraseña -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resetPasswordModalLabel">Nueva contraseña</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <form id="resetPasswordForm">
              <div class="mb-3">
                <label for="resetPassword" class="form-label">Nueva contraseña</label>
                <input type="password" class="form-control" id="resetPassword" required>
              </div>
              <div class="alert alert-info d-none" id="resetPasswordMsg"></div>
              <button type="button" class="btn btn-secondary w-100" id="cambiarContrasenaBtn">Cambiar contraseña</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous" defer></script>
    <script src="config/ngrok-config.js"></script>
    
    <!-- Blog JS -->
    <script>
      // Variables globales
      let allPosts = [];
      let filteredPosts = [];
      let currentPage = 1;
      let postsPerPage = 3;
      let isLoading = false;
      let currentFilters = {
        search: '',
        categoria: '',
        orden: 'fecha_desc'
      };
      let correoRecuperacion = null;

      // Función para generar URL de post
      function generatePostUrl(slug, categorias) {
        if (categorias && categorias.length > 0) {
          const categoriaSlug = categorias[0].toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
          return `${slug}/${categoriaSlug}`;
        }
        return slug;
      }

      // Función para obtener imagen por defecto
      function getDefaultImage(categorias) {
        if (!categorias) return 'imagenes/panal.png';
        
        const categoriasLower = categorias.toLowerCase();
        if (categoriasLower.includes('genética') || categoriasLower.includes('investigación')) {
          return 'imagenes/cajas.png';
        } else if (categoriasLower.includes('polinización') || categoriasLower.includes('cultivos')) {
          return 'imagenes/colema.png';
        }
        return 'imagenes/panal.png';
      }

      // Cargar posts
      const loadPosts = async () => {
        try {
          const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/posts/recent`);
          if (!response.ok) {
            throw new Error('Error al cargar posts');
          }
          allPosts = await response.json();
          filteredPosts = [...allPosts];
          renderPosts();
          loadCategories();
        } catch (error) {
          console.error('Error al cargar posts:', error);
          const container = document.getElementById('postsContainer');
          if (container) {
            container.innerHTML = `
              <div class="col-12 text-center">
                <div class="alert alert-info">
                  <p>No se pudieron cargar los posts. Por favor, intenta más tarde.</p>
                </div>
              </div>
            `;
          }
        }
      };

      // Cargar categorías para filtros
      const loadCategories = async () => {
        try {
          const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/categories/filter`);
          if (!response.ok) {
            throw new Error('Error al cargar categorías');
          }
          const categories = await response.json();
          
          const dropdown = document.getElementById('categoriasDropdown');
          const existingItems = dropdown.querySelectorAll('li:not(:first-child)');
          existingItems.forEach(item => item.remove());
          
          categories.forEach(category => {
            const li = document.createElement('li');
            li.innerHTML = `
              <a class="dropdown-item" href="#" data-categoria="${category.nom_categoria}">
                ${category.nom_categoria} (${category.post_count})
              </a>
            `;
            dropdown.appendChild(li);
          });
        } catch (error) {
          console.error('Error al cargar categorías:', error);
        }
      };

      // Aplicar filtros
      const applyFilters = () => {
        filteredPosts = allPosts.filter(post => {
          // Filtro de búsqueda
          if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            const title = post.titulo.toLowerCase();
            
            if (!title.includes(searchTerm)) {
              return false;
            }
          }
          
          // Filtro de categoría
          if (currentFilters.categoria) {
            const postCategories = post.categorias ? post.categorias.split(',') : [];
            if (!postCategories.some(cat => cat.trim() === currentFilters.categoria)) {
              return false;
            }
          }
          
          return true;
        });
        
        // Aplicar ordenamiento
        filteredPosts.sort((a, b) => {
          const dateA = new Date(a.fecha_publicacion);
          const dateB = new Date(b.fecha_publicacion);
          
          switch (currentFilters.orden) {
            case 'fecha_asc':
              return dateA - dateB;
            case 'fecha_desc':
            default:
              return dateB - dateA;
            case 'titulo_asc':
              return a.titulo.localeCompare(b.titulo);
            case 'titulo_desc':
              return b.titulo.localeCompare(a.titulo);
          }
        });
        
        currentPage = 1;
        renderPosts();
      };

      // Renderizar posts
      const renderPosts = () => {
        const container = document.getElementById('postsContainer');
        if (!container) return;

        if (filteredPosts.length === 0) {
          container.innerHTML = `
            <div class="col-12 text-center">
              <div class="alert alert-info">
                <p>No se encontraron posts que coincidan con los filtros aplicados.</p>
              </div>
            </div>
          `;
          updateLoadButtons();
          return;
        }

        const startIndex = 0;
        const endIndex = currentPage * postsPerPage;
        const postsToShow = filteredPosts.slice(startIndex, endIndex);

        container.innerHTML = postsToShow.map(post => {
          const defaultImage = getDefaultImage(post.categorias);
          const imagen = post.imagenes ? post.imagenes.split(',')[0] : defaultImage;
          const contenidoLimpio = post.contenido.replace(/<[^>]*>/g, '').substring(0, 150);
          const fecha = new Date(post.fecha_publicacion).toLocaleDateString('es-ES', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
          });
          
          const categorias = post.categorias ? post.categorias.split(',') : [];
          const postUrl = `/blog/${generatePostUrl(post.slug, categorias)}`;

          return `
            <div class="col">
              <div class="card blog-card">
                <img src="${imagen}" class="card-img-top" alt="${post.titulo}" loading="lazy" width="400" height="224">
                <div class="card-body">
                  <div class="d-flex gap-2 mb-2">
                    ${categorias.map(cat => 
                      `<span class="badge">${cat.trim()}</span>`
                    ).join('')}
                  </div>
                  <small class="text-muted">${fecha}</small>
                  <h4 class="card-title text-accent my-2">${post.titulo}</h4>
                  <p class="card-text">
                    ${contenidoLimpio}...
                  </p>
                  <a href="${postUrl}" class="read-more btn btn-link p-0">
                    Leer más <span class="material-icons align-middle fs-6">arrow_forward</span>
                  </a>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        updateLoadButtons();
      };

      // Actualizar botones de carga
      const updateLoadButtons = () => {
        const btnCargarMas = document.getElementById('btn-cargar-mas');
        const btnCargarMenos = document.getElementById('btn-cargar-menos');
        
        if (filteredPosts.length <= postsPerPage) {
          btnCargarMas.style.display = 'none';
          btnCargarMenos.style.display = 'none';
        } else if (currentPage * postsPerPage >= filteredPosts.length) {
          btnCargarMas.style.display = 'none';
          btnCargarMenos.style.display = 'inline-flex';
        } else {
          btnCargarMas.style.display = 'inline-flex';
          btnCargarMenos.style.display = 'none';
        }
      };

      // Función debounce para búsqueda
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Búsqueda con debounce
      const realizarBusqueda = debounce(() => {
        currentFilters.search = document.getElementById('searchInput').value.trim();
        applyFilters();
      }, 300);

      // Event Listeners
      document.addEventListener('DOMContentLoaded', () => {
        loadPosts();
        
        // Botón volver arriba
        const btnVolverArriba = document.getElementById('btn-volver-arriba');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              btnVolverArriba.classList.add('d-none');
            } else {
              btnVolverArriba.classList.remove('d-none');
            }
          });
        }, { threshold: 0.1 });

        observer.observe(document.querySelector('.blog-header'));

        btnVolverArriba.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });

        // Búsqueda
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        
        searchButton.addEventListener('click', realizarBusqueda);
        searchInput.addEventListener('input', realizarBusqueda);

        // Filtros de fecha
        document.querySelectorAll('[data-orden]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            currentFilters.orden = e.target.dataset.orden;
            applyFilters();
          });
        });

        // Filtros de categoría
        document.addEventListener('click', (e) => {
          if (e.target.matches('[data-categoria]')) {
            e.preventDefault();
            currentFilters.categoria = e.target.dataset.categoria;
            applyFilters();
          }
        });

        // Limpiar filtros
        document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
          currentFilters = {
            search: '',
            categoria: '',
            orden: 'fecha_desc'
          };
          document.getElementById('searchInput').value = '';
          applyFilters();
        });

        // Botones de carga
        document.getElementById('btn-cargar-mas').addEventListener('click', () => {
          if (isLoading) return;
          
          isLoading = true;
          const btn = document.getElementById('btn-cargar-mas');
          const loadingText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cargando...';
          
          setTimeout(() => {
            currentPage++;
            renderPosts();
            btn.innerHTML = loadingText;
            isLoading = false;
          }, 500);
        });

        document.getElementById('btn-cargar-menos').addEventListener('click', () => {
          if (isLoading) return;
          
          isLoading = true;
          const btn = document.getElementById('btn-cargar-menos');
          const loadingText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cargando...';
          
          setTimeout(() => {
            currentPage = 1;
            renderPosts();
            btn.innerHTML = loadingText;
            isLoading = false;
          }, 500);
        });

        // Login functionality
        document.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
          }
        });

        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');

        // Función para manejar el login
        const handleLogin = async () => {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          try {
            const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (data.success) {
              if (data.user.role === 'admin') {
                localStorage.setItem('username', username);
                localStorage.setItem('password', password);
                window.location.href = 'admin.html';
              } else {
                loginError.textContent = 'No tienes permisos de administrador';
                loginError.classList.remove('d-none');
              }
            } else {
              loginError.textContent = 'Credenciales inválidas';
              loginError.classList.remove('d-none');
            }
          } catch (error) {
            loginError.textContent = 'Error al conectar con el servidor';
            loginError.classList.remove('d-none');
          }
        };

        // Event listener para el botón de login
        loginButton.addEventListener('click', handleLogin);

        // Event listener para el formulario (Enter key)
        loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          handleLogin();
        });

        // Event listeners para campos de entrada (Enter key)
        document.getElementById('username').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('password').focus();
          }
        });

        document.getElementById('password').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleLogin();
          }
        });

        // Lógica de recuperación de contraseña
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        const verifyTokenModal = new bootstrap.Modal(document.getElementById('verifyTokenModal'));
        const resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));

        // Paso 1: Solicitar correo
        forgotPasswordLink.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('forgotPasswordForm').reset();
          document.getElementById('forgotPasswordMsg').classList.add('d-none');
          correoRecuperacion = null;
          forgotPasswordModal.show();
        });

        document.getElementById('enviarCodigoBtn').addEventListener('click', async function(e) {
          e.preventDefault();
          const correo = document.getElementById('forgotCorreo').value;
          correoRecuperacion = correo;
          const msg = document.getElementById('forgotPasswordMsg');
          msg.classList.add('d-none', 'alert-danger', 'alert-info');
          try {
            const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/forgot-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ correo })
            });
            const data = await response.json();
            msg.textContent = data.message;
            msg.classList.remove('d-none');
            if (data.success) {
              msg.classList.remove('alert-danger');
              msg.classList.add('alert-info');
              setTimeout(() => {
                forgotPasswordModal.hide();
                document.getElementById('verifyTokenForm').reset();
                document.getElementById('verifyTokenMsg').classList.add('d-none');
                verifyTokenModal.show();
              }, 1500);
            } else {
              msg.classList.remove('alert-info');
              msg.classList.add('alert-danger');
              // Botón para volver al index
              msg.innerHTML += '<br><button id="volverIndexBtn" class="btn btn-outline-primary mt-3">Volver al inicio</button>';
              document.getElementById('volverIndexBtn').onclick = function() {
                window.location.href = "index1.html";
              };
            }
          } catch (error) {
            msg.textContent = 'Error al solicitar recuperación.';
            msg.classList.remove('d-none', 'alert-info');
            msg.classList.add('alert-danger');
          }
        });

        // Paso 2: Verificar código
        document.getElementById('verificarCodigoBtn').addEventListener('click', async function(e) {
          e.preventDefault();
          const token = document.getElementById('verifyToken').value;
          const msg = document.getElementById('verifyTokenMsg');
          msg.classList.add('d-none');
          try {
            const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/verify-reset-token`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ correo: correoRecuperacion, token })
            });
            const data = await response.json();
            msg.textContent = data.message;
            msg.classList.remove('d-none');
            if (data.success) {
              setTimeout(() => {
                verifyTokenModal.hide();
                document.getElementById('resetPasswordForm').reset();
                document.getElementById('resetPasswordMsg').classList.add('d-none');
                resetPasswordModal.show();
                // Guardar token para el siguiente paso
                resetPasswordModal.token = token;
              }, 1000);
            }
          } catch (error) {
            msg.textContent = 'Error al verificar el código.';
            msg.classList.remove('d-none');
          }
        });

        // Paso 3: Cambiar contraseña
        document.getElementById('cambiarContrasenaBtn').addEventListener('click', async function(e) {
          e.preventDefault();
          const nuevaPassword = document.getElementById('resetPassword').value;
          const msg = document.getElementById('resetPasswordMsg');
          msg.classList.add('d-none');
          try {
            const response = await fetch(`${window.ngrokConfig ? window.ngrokConfig.getBaseURL() : 'http://localhost:8080'}/api/reset-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ correo: correoRecuperacion, token: resetPasswordModal.token, nuevaPassword })
            });
            const data = await response.json();
            msg.textContent = data.message;
            msg.classList.remove('d-none');
            if (data.success) {
              setTimeout(() => {
                resetPasswordModal.hide();
                alert('¡Contraseña cambiada con éxito! Ahora puedes iniciar sesión.');
              }, 1500);
            }
          } catch (error) {
            msg.textContent = 'Error al cambiar la contraseña.';
            msg.classList.remove('d-none');
          }
        });
      });
    </script>
  </body>
</html>
    